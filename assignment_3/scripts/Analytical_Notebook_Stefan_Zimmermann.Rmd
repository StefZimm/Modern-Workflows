---
title: "Analytical Notebook"
author: "Stefan Zimmermann"
date: "11 7 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install and load R-Packages
```{r, message=FALSE, results="hide"}
# install and load packages
loadpackage <- function(x){
  for( i in x ){
    #  require returns TRUE invisibly if it was able to load package
    if( ! require( i , character.only = TRUE ) ){
      #  If package was not able to be loaded then re-install
      install.packages( i , dependencies = TRUE )
    }
    #  Load package (after installing)
    library( i , character.only = TRUE )
  }
}

# load packages
loadpackage( c("readr", "knitr", "dplyr", "tidyr", "sparklyr"))
```
## Load [Covid-Datasets](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data)

The datasets [UID_ISO_FIPS_LookUp_Table.csv](https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv) and [time_series_covid19_confirmed_global.csv](https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv) are loaded. 

```{r, message=FALSE, results="hide"}
# use url to current dataset
url_data1 <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
url_data2 <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"

# load datasets
data1 <- read_csv(url_data1)
data2 <- read_csv(url_data2)

# harmonise ID-Variables in both datasets
names(data1)[names(data1) == "Long_"] <- "Long"
names(data2)[names(data2) == "Country/Region"] <- "Country_Region"
names(data2)[names(data2) == "Province/State"] <- "Province_State"

# Since we are only interested in countries and not in regions
# we keep only a subset of the dataset without regions. 
data1 <-subset(data1, is.na(data1$Province_State))
data2 <-subset(data2, is.na(data2$Province_State))

data2 <- 
  reshape(
    data = as.data.frame(data2),
    varying = list(names(data2)[5:length(data2)]),
    timevar = "day",
    v.names = "count",
    idvar = c("Country_Region"),
    direction = "long",
    times = names(data2)[5:length(data2)]
  )  

data2$date <- as.Date(data2$day, format = "%m/%d/%y")
data2$datecount <- data2$date-min(data2$date)

# setting up spark
sc <- spark_connect(master = "local",
                    version = "2.4.3")

data1 <- copy_to(sc, data1, overwrite = T)
data2 <- copy_to(sc, data2, overwrite = T)
src_tbls(sc)

```

## Data Cleaning

Here the data sets are prepared for merging and reshaping. The ID variables must be standardized. 
Since we are only interested in countries and not in regions # we keep only a subset of the dataset without regions. Then we drop countries without information and we keep all important variables. We reshape the dataset to long format

```{r}
data_merge <- merge(data1, data2)
data_merge <- data_merge %>% 
  select(Country_Region, Country_Region, day, date, count, datecount)

data_merge <- copy_to(sc, data_merge, overwrite = T)

#trim <- function (x) gsub("^\\s+|\\s+$", "", x)
#data_merge <- trim(data_merge)

# data_merge
# Germany, China,Japan, United Kingdom, US, Brazil, Mexico 
my_table <- data_merge %>%
  filter(Country_Region=="Brazil", Country_Region=="Mexico") %>% 
  collect() %>%  
  print()


```

# Check Countries without infos
data_wide$Country_Region[is.na(data_wide$`1/22/20`)]
data_wide$Country_Region[is.na(data_wide$Population)]
# drop countries without info
data_wide <- data_wide %>% drop_na(`1/22/20`)
data_wide <- data_wide %>% drop_na(Population)

# keep only necessary variables
data_wide <-subset(data_wide, select = c("Country_Region", "Population",
                                         names(data_wide)[16:length(data_wide)]))

# Reshape wide to long
data_long <- 
  reshape(
    data = as.data.frame(data_wide),
    varying = list(names(data_wide)[3:length(data_wide)]),
    timevar = "day",
    v.names = "count",
    idvar = c("Country_Region"),
    direction = "long",
    times = names(data_wide)[3:length(data_wide)]
  )    
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
